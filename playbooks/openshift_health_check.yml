---
- hosts: localhost
  gather_facts: no
  vars:
    eda_webhook_url: "http://eda-route:5000"  # Replace with your EDA webhook URL

  tasks:

    - name: Check Cluster Operators
      command: oc get co -o json
      register: co_json
      failed_when: >
        (co_json.stdout | from_json).items | selectattr('status.conditions', 'defined') |
        selectattr('status.conditions', 'search', 'Degraded') | list | length > 0

    - name: Check Machine Config Pools
      command: oc get mcp -o json
      register: mcp_json
      failed_when: >
        (mcp_json.stdout | from_json).items | selectattr('status.conditions', 'defined') |
        selectattr('status.conditions', 'search', 'Degraded') | list | length > 0

    - name: Check Nodes
      command: oc get nodes -o json
      register: nodes_json
      failed_when: >
        (nodes_json.stdout | from_json).items | selectattr('status.conditions', 'defined') |
        selectattr('status.conditions', 'search', 'NotReady') | list | length > 0

    - name: Check Certificates
      command: oc get cert -A -o json
      register: certs_json
      failed_when: >
        (certs_json.stdout | from_json).items | selectattr('status.conditions', 'defined') |
        selectattr('status.conditions', 'search', 'False') | list | length > 0

    - name: Check Pods
      command: oc get pods -A
      register: pods
      failed_when: >
        pods.stdout_lines | select("search", "(0/1|0/2|0/3|Error|CrashLoopBackOff|Pending)") | list | length > 0

    - name: Notify EDA only on failure
      when: co_json.failed or mcp_json.failed or nodes_json.failed or certs_json.failed or pods.failed
      uri:
        url: "{{ eda_webhook_url }}"
        method: POST
        body_format: json
        body:
          status: failed
          checks_failed: >
            {% set list=[] %}
            {% if co_json.failed %}{{ list.append('ClusterOperators') }}{% endif %}
            {% if mcp_json.failed %}{{ list.append('MCP') }}{% endif %}
            {% if nodes_json.failed %}{{ list.append('Nodes') }}{% endif %}
            {% if certs_json.failed %}{{ list.append('Certificates') }}{% endif %}
            {% if pods.failed %}{{ list.append('Pods') }}{% endif %}
            {{ list }}
