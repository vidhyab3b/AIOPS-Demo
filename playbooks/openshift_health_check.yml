---
- hosts: localhost
  gather_facts: no

  tasks:
    - name: Check Cluster Operators
      command: oc get co -o json
      register: co_json
      failed_when: >
        (co_json.stdout | from_json | json_query("items[?status.conditions[?type=='Degraded' && status=='True']]") | length) > 0

    - name: Check Machine Config Pools
      command: oc get mcp -o json
      register: mcp_json
      failed_when: >
        (mcp_json.stdout | from_json | json_query("items[?status.conditions[?type=='Degraded' && status=='True']]") | length) > 0

    - name: Check Nodes
      command: oc get nodes -o json
      register: nodes_json
      failed_when: >
        (nodes_json.stdout | from_json | json_query("items[?status.conditions[?type=='Ready' && status!='True'] or spec.unschedulable==`true`]") | length) > 0

    - name: Check Certificates
      command: oc get cert -A -o json
      register: certs_json
      failed_when: >
        (certs_json.stdout | from_json | json_query("items[?status.conditions[?type=='Ready' && status=='False']]") | length) > 0

    - name: Check Pods
      command: oc get pods -A -o json
      register: pods_json
      failed_when: >
        (pods_json.stdout | from_json | json_query("items[?status.phase!='Running' && status.phase!='Succeeded']") | length) > 0

    - name: Notify EDA only on failure
      when: co_json.failed or mcp_json.failed or nodes_json.failed or certs_json.failed or pods_json.failed
      uri:
        url: "http://eda-route:5000"    # Replace with your EDA webhook URL
        method: POST
        body_format: json
        body:
          status: failed
          checks_failed: >
            {% set list=[] %}
            {% if co_json.failed %}{{ list.append('ClusterOperators') }}{% endif %}
            {% if mcp_json.failed %}{{ list.append('MCP') }}{% endif %}
            {% if nodes_json.failed %}{{ list.append('Nodes') }}{% endif %}
            {% if certs_json.failed %}{{ list.append('Certificates') }}{% endif %}
            {% if pods_json.failed %}{{ list.append('Pods') }}{% endif %}
            {{ list }}
