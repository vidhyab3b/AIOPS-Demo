---
- name: OpenShift Pod Alert
  hosts: localhost
  gather_facts: no

  vars:
    email_to: vvidhya@redhat.com
    email_from: vidyavece@gmail.com
    smtp_host: smtp.gmail.com
    smtp_port: 587

  tasks:
    - name: Send OpenShift pod alert email
      mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        secure: starttls
        username: "{{ lookup('env', 'GMAIL_USERNAME') }}"
        password: "{{ lookup('env', 'GMAIL_APP_PASSWORD') }}"
        to: "{{ email_to }}"
        from: "{{ email_from }}"
        subject: "OpenShift Pod Alert: {{ pod_name }} in {{ namespace }} is {{ pod_status }}"
        body: |
          OpenShift Pod Alert Detected

          Namespace  : {{ namespace | default('unknown') }}
          Pod Name   : {{ pod_name | default('unknown') }}
          Pod Status : {{ pod_status | default('unknown') }}
          Time       : {{ ansible_date_time.iso8601 }}

          {% if container_issues is defined and container_issues|length > 0 %}
          Container Issues:
          {% for c in container_issues %}
            - Container: {{ c.name }}, Reason: {{ c.reason }}, Message: {{ c.message }}
          {% endfor %}
          {% endif %}

          This alert was automatically triggered by Ansible EDA.
